# Cache Invalidation ìµœì í™” ë¶„ì„

## ğŸ“Š í˜„ì¬ ìƒí™© ë¶„ì„

### 1. ë°ì´í„° íë¦„
```
Todo ìƒì„± (useCreateTodo)
  â†“
onSettled ì‹¤í–‰
  â†“
invalidateQueries(['todos', date])      â† íŠ¹ì • ë‚ ì§œ
invalidateQueries(['todos', 'all'])     â† ì „ì²´ ëª©ë¡
invalidateQueries(['todos', 'category', id])  â† ì¹´í…Œê³ ë¦¬ë³„
  â†“
ìë™ Refetch ë°œìƒ
  â†“
useTodos(date)      â†’ SQLite ì¡°íšŒ (3ë²ˆ í˜¸ì¶œ)
useAllTodos()       â†’ SQLite ì¡°íšŒ (3ë²ˆ í˜¸ì¶œ)
```

### 2. ë¡œê·¸ ë¶„ì„
```
ğŸ“ [useTodos] getTodosByDate: 3ê°œ (48.90ms)
âš¡ [useAllTodos] SQLite ì¡°íšŒ: 7ê°œ (48.90ms)
âš¡ [useAllTodos] SQLite ì¡°íšŒ: 7ê°œ (49.80ms)  â† ì¤‘ë³µ
ğŸ“ [useTodos] getTodosByDate: 3ê°œ (50.30ms)  â† ì¤‘ë³µ
ğŸ“ [useTodos] getTodosByDate: 3ê°œ (9.10ms)   â† ì¤‘ë³µ
âš¡ [useAllTodos] SQLite ì¡°íšŒ: 7ê°œ (9.10ms)   â† ì¤‘ë³µ
```

**ì¤‘ë³µ í˜¸ì¶œ ì›ì¸:**
- `useTodos(date)`: TodoScreen, DebugScreenì—ì„œ ë™ì‹œ ì‚¬ìš©
- `useAllTodos()`: CalendarScreen (useCalendarDynamicEvents)ì—ì„œ ì‚¬ìš©
- ê° ì»´í¬ë„ŒíŠ¸ê°€ ë§ˆìš´íŠ¸ë˜ë©´ì„œ ë™ì‹œì— refetch ë°œìƒ

### 3. ì‚¬ìš©ì²˜ ë§¤í•‘

| Hook | ì‚¬ìš© ì»´í¬ë„ŒíŠ¸ | ëª©ì  |
|------|-------------|------|
| `useTodos(date)` | TodoScreen | ë‚ ì§œë³„ Todo í‘œì‹œ |
| `useTodos(date)` | DebugScreen | ë””ë²„ê·¸ ì •ë³´ |
| `useAllTodos()` | CalendarScreen | ìº˜ë¦°ë” ì´ë²¤íŠ¸ ìƒì„± |
| `useTodosByCategory(id)` | CategoryTodosScreen | ì¹´í…Œê³ ë¦¬ë³„ Todo |

---

## ğŸ” ì„±ëŠ¥ ì˜í–¥ ë¶„ì„

### A. í˜„ì¬ ë¹„ìš© (Todo 1ê°œ ìƒì„± ì‹œ)

| í•­ëª© | íšŸìˆ˜ | ì‹œê°„ | ì´ ë¹„ìš© |
|------|------|------|---------|
| SQLite ì¡°íšŒ (ë‚ ì§œë³„) | 3íšŒ | ~10-50ms | 30-150ms |
| SQLite ì¡°íšŒ (ì „ì²´) | 3íšŒ | ~10-50ms | 30-150ms |
| Completion ì¡°íšŒ | 3íšŒ | ~110ms | 330ms |
| **ì´í•©** | **9íšŒ** | - | **390-630ms** |

**ì‹¤ì œ ì²´ê°:**
- ì²« ì¡°íšŒ: 48ms (ì½œë“œ ìŠ¤íƒ€íŠ¸)
- ì´í›„ ì¡°íšŒ: 9-10ms (ìºì‹œ íš¨ê³¼)
- **í‰ê· : ~200ms** (ì‚¬ìš©ìëŠ” ê±°ì˜ ëŠë¼ì§€ ëª»í•¨)

### B. ìµœì í™” í›„ ì˜ˆìƒ ë¹„ìš©

#### ì˜µì…˜ 1: Optimistic Update
```javascript
// ì„œë²„ ì‘ë‹µ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  ì¦‰ì‹œ ìºì‹œ ì—…ë°ì´íŠ¸
queryClient.setQueryData(['todos', date], (old) => [...old, newTodo]);
```

| í•­ëª© | íšŸìˆ˜ | ì‹œê°„ | ì´ ë¹„ìš© |
|------|------|------|---------|
| ìºì‹œ ì§ì ‘ ì—…ë°ì´íŠ¸ | 1íšŒ | <1ms | <1ms |
| SQLite ì¡°íšŒ | 0íšŒ | 0ms | 0ms |
| **ì´í•©** | **1íšŒ** | - | **<1ms** |

**ì¥ì :**
- âœ… ì¦‰ê°ì ì¸ UI ë°˜ì‘ (0ms)
- âœ… ë„¤íŠ¸ì›Œí¬ ëŒ€ê¸° ë¶ˆí•„ìš”
- âœ… SQLite ì¡°íšŒ ì œê±°

**ë‹¨ì :**
- âš ï¸ ì„œë²„ ì‹¤íŒ¨ ì‹œ ë¡¤ë°± í•„ìš”
- âš ï¸ ë³µì¡í•œ ìƒíƒœ ê´€ë¦¬ (ë‚ ì§œë³„, ì „ì²´, ì¹´í…Œê³ ë¦¬ë³„ ëª¨ë‘ ì—…ë°ì´íŠ¸)
- âš ï¸ Completion ìƒíƒœ ë³‘í•© ë¡œì§ ì¤‘ë³µ

#### ì˜µì…˜ 2: ë¶€ë¶„ Invalidate (í˜„ì¬ ë°©ì‹ ê°œì„ )
```javascript
// í•„ìš”í•œ ì¿¼ë¦¬ë§Œ invalidate
queryClient.invalidateQueries({ 
  queryKey: ['todos', date],
  refetchType: 'active' // í™œì„± ì¿¼ë¦¬ë§Œ refetch
});
```

| í•­ëª© | íšŸìˆ˜ | ì‹œê°„ | ì´ ë¹„ìš© |
|------|------|------|---------|
| SQLite ì¡°íšŒ (í™œì„±ë§Œ) | 1-2íšŒ | ~10-50ms | 10-100ms |
| **ì´í•©** | **1-2íšŒ** | - | **10-100ms** |

**ì¥ì :**
- âœ… êµ¬í˜„ ê°„ë‹¨ (1ì¤„ ìˆ˜ì •)
- âœ… ì•ˆì •ì„± ìœ ì§€ (SQLiteê°€ Source of Truth)
- âœ… ì¤‘ë³µ í˜¸ì¶œ ì œê±°

**ë‹¨ì :**
- âš ï¸ ì—¬ì „íˆ SQLite ì¡°íšŒ ë°œìƒ (í•˜ì§€ë§Œ ì¶©ë¶„íˆ ë¹ ë¦„)

---

## ğŸ’¡ ìµœì í™” í•„ìš”ì„± íŒë‹¨

### 1. ì •ëŸ‰ì  ë¶„ì„

| ì§€í‘œ | í˜„ì¬ | ìµœì í™” í›„ | ê°œì„ ìœ¨ |
|------|------|----------|--------|
| ì´ ì¡°íšŒ íšŸìˆ˜ | 9íšŒ | 1-2íšŒ | **78-89% ê°ì†Œ** |
| í‰ê·  ì‘ë‹µ ì‹œê°„ | 200ms | 10-50ms | **75-95% ê°œì„ ** |
| ì‚¬ìš©ì ì²´ê° | ê±°ì˜ ì—†ìŒ | ì—†ìŒ | - |

### 2. ì •ì„±ì  ë¶„ì„

#### ìµœì í™”ê°€ í•„ìš”í•œ ê²½ìš° âœ…
- [ ] ì‚¬ìš©ìê°€ ì§€ì—°ì„ ì²´ê°í•¨ (200msëŠ” ì²´ê° ì•ˆ ë¨)
- [x] ë°°í„°ë¦¬ ì†Œëª¨ê°€ ë¬¸ì œë¨ (9íšŒ ì¡°íšŒëŠ” ë¹„íš¨ìœ¨)
- [x] ì½”ë“œ ë³µì¡ë„ê°€ ë‚®ìŒ (refetchType ì¶”ê°€ë§Œ)
- [x] í™•ì¥ì„± ë¬¸ì œ (Todo 1000ê°œ ì´ìƒ ì‹œ)

#### ìµœì í™”ê°€ ë¶ˆí•„ìš”í•œ ê²½ìš° âŒ
- [x] í˜„ì¬ ì„±ëŠ¥ì´ ì¶©ë¶„í•¨ (10-50msëŠ” ë¹ ë¦„)
- [x] ë³µì¡ë„ ì¦ê°€ ìš°ë ¤ (Optimistic UpdateëŠ” ë³µì¡)
- [ ] ë‹¤ë¥¸ ë³‘ëª©ì´ ë” ì‹¬ê°í•¨ (í˜„ì¬ ì—†ìŒ)

---

## ğŸ¯ ê¶Œì¥ ì‚¬í•­

### ë‹¨ê¸° (ì§€ê¸ˆ ë‹¹ì¥)
**ê²°ë¡ : ìµœì í™” ë³´ë¥˜ â¸ï¸**

**ì´ìœ :**
1. **ì²´ê° ì„±ëŠ¥ ì¶©ë¶„**: 200msëŠ” ì‚¬ìš©ìê°€ ëŠë¼ì§€ ëª»í•˜ëŠ” ìˆ˜ì¤€
2. **SQLite ì¶©ë¶„íˆ ë¹ ë¦„**: 9-50msëŠ” ë„¤ì´í‹°ë¸Œ ìˆ˜ì¤€
3. **ì•ˆì •ì„± ìš°ì„ **: í˜„ì¬ êµ¬ì¡°ê°€ ë‹¨ìˆœí•˜ê³  ì•ˆì •ì 
4. **ë‹¤ë¥¸ ìš°ì„ ìˆœìœ„**: UUID í…ŒìŠ¤íŠ¸, ë™ê¸°í™” ì•ˆì •ì„±ì´ ë” ì¤‘ìš”

**ëª¨ë‹ˆí„°ë§ ì§€í‘œ:**
```javascript
// ì´ ê°’ë“¤ì´ ì¦ê°€í•˜ë©´ ìµœì í™” ê³ ë ¤
- SQLite ì¡°íšŒ ì‹œê°„ > 100ms
- Todo ê°œìˆ˜ > 1000ê°œ
- ì‚¬ìš©ì ë¶ˆë§Œ ì ‘ìˆ˜
```

### ì¤‘ê¸° (Todo 500ê°œ ì´ìƒ ì‹œ)
**ê¶Œì¥: ì˜µì…˜ 2 (ë¶€ë¶„ Invalidate) ì ìš©**

```javascript
// useCreateTodo.js - onSettled
queryClient.invalidateQueries({ 
  queryKey: ['todos', startDate],
  refetchType: 'active' // í˜„ì¬ í™”ë©´ì— ë³´ì´ëŠ” ì¿¼ë¦¬ë§Œ
});
```

**ì˜ˆìƒ íš¨ê³¼:**
- ì¤‘ë³µ í˜¸ì¶œ ì œê±° (9íšŒ â†’ 1-2íšŒ)
- ì½”ë“œ ë³€ê²½ ìµœì†Œ (1ì¤„)
- ì•ˆì •ì„± ìœ ì§€

### ì¥ê¸° (Todo 1000ê°œ ì´ìƒ ì‹œ)
**ê¶Œì¥: Optimistic Update + ê°€ìƒí™”**

```javascript
// 1. Optimistic Update
queryClient.setQueryData(['todos', date], (old) => [...old, newTodo]);

// 2. FlashList ê°€ìƒí™” (ì´ë¯¸ ì ìš©ë¨)
// 3. SQLite ì¸ë±ì‹± ê°•í™”
```

---

## ğŸ“ˆ í™•ì¥ì„± ì‹œë®¬ë ˆì´ì…˜

### Todo ê°œìˆ˜ë³„ ì˜ˆìƒ ì„±ëŠ¥

| Todo ê°œìˆ˜ | í˜„ì¬ (9íšŒ ì¡°íšŒ) | ìµœì í™” (1íšŒ) | Optimistic |
|-----------|----------------|--------------|------------|
| 10ê°œ | 200ms | 50ms | <1ms |
| 100ê°œ | 300ms | 80ms | <1ms |
| 500ê°œ | 600ms | 150ms | <1ms |
| 1000ê°œ | 1200ms âš ï¸ | 300ms | <1ms |

**ì„ê³„ì : 500ê°œ**
- 500ê°œ ì´ìƒë¶€í„° ìµœì í™” í•„ìš”
- í˜„ì¬ ì‚¬ìš©ìëŠ” í‰ê·  10-50ê°œ ì˜ˆìƒ

---

## ğŸ”§ êµ¬í˜„ ë³µì¡ë„ ë¹„êµ

### ì˜µì…˜ 1: Optimistic Update
```javascript
// ë³µì¡ë„: ë†’ìŒ (50ì¤„ ì´ìƒ)
// ìœ ì§€ë³´ìˆ˜: ì–´ë ¤ì›€
// ì•ˆì •ì„±: ì¤‘ê°„ (ë¡¤ë°± ë¡œì§ í•„ìš”)

onMutate: async (newTodo) => {
  // 1. ì§„í–‰ ì¤‘ì¸ refetch ì·¨ì†Œ
  await queryClient.cancelQueries(['todos', date]);
  
  // 2. ì´ì „ ë°ì´í„° ë°±ì—…
  const previous = queryClient.getQueryData(['todos', date]);
  
  // 3. Optimistic ì—…ë°ì´íŠ¸
  queryClient.setQueryData(['todos', date], (old) => [...old, newTodo]);
  queryClient.setQueryData(['todos', 'all'], (old) => [...old, newTodo]);
  
  // 4. ë¡¤ë°± ì •ë³´ ë°˜í™˜
  return { previous };
},
onError: (err, newTodo, context) => {
  // 5. ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
  queryClient.setQueryData(['todos', date], context.previous);
}
```

### ì˜µì…˜ 2: ë¶€ë¶„ Invalidate
```javascript
// ë³µì¡ë„: ë‚®ìŒ (1ì¤„ ìˆ˜ì •)
// ìœ ì§€ë³´ìˆ˜: ì‰¬ì›€
// ì•ˆì •ì„±: ë†’ìŒ (SQLiteê°€ Source of Truth)

queryClient.invalidateQueries({ 
  queryKey: ['todos', startDate],
  refetchType: 'active' // ì´ê²ƒë§Œ ì¶”ê°€
});
```

---

## ğŸ¬ ìµœì¢… ê²°ë¡ 

### í˜„ì¬ ìƒíƒœ: **ìµœì í™” ë¶ˆí•„ìš”** âœ…

**ê·¼ê±°:**
1. **ì„±ëŠ¥ ì¶©ë¶„**: 200msëŠ” ì²´ê° ë¶ˆê°€ ìˆ˜ì¤€
2. **SQLite ë¹ ë¦„**: 9-50msëŠ” ë„¤ì´í‹°ë¸Œê¸‰
3. **ì•ˆì •ì„± ìš°ì„ **: í˜„ì¬ êµ¬ì¡°ê°€ ë‹¨ìˆœí•˜ê³  ê²€ì¦ë¨
4. **ì¡°ê¸° ìµœì í™” ë°©ì§€**: "Premature optimization is the root of all evil"

### ìµœì í™” íŠ¸ë¦¬ê±° ì¡°ê±´

ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¼ë„ ë°œìƒ ì‹œ ì¬ê²€í† :
- [ ] SQLite ì¡°íšŒ ì‹œê°„ > 100ms
- [ ] Todo ê°œìˆ˜ > 500ê°œ
- [ ] ì‚¬ìš©ì ë¶ˆë§Œ ì ‘ìˆ˜
- [ ] ë°°í„°ë¦¬ ì†Œëª¨ ì´ìŠˆ

### ì¶”ì²œ ì•¡ì…˜

**ì§€ê¸ˆ:**
- âœ… í˜„ì¬ êµ¬ì¡° ìœ ì§€
- âœ… UUID í…ŒìŠ¤íŠ¸ ìš°ì„ 
- âœ… ë™ê¸°í™” ì•ˆì •ì„± í™•ë³´

**ë‚˜ì¤‘ì— (í•„ìš” ì‹œ):**
- ğŸ“Š ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì¶”ê°€
- ğŸ”§ ì˜µì…˜ 2 (ë¶€ë¶„ Invalidate) ì ìš©
- ğŸš€ Optimistic UpdateëŠ” ë§ˆì§€ë§‰ ìˆ˜ë‹¨

---

## ğŸ“š ì°¸ê³  ìë£Œ

### React Query Best Practices
- [Optimistic Updates](https://tanstack.com/query/latest/docs/react/guides/optimistic-updates)
- [Query Invalidation](https://tanstack.com/query/latest/docs/react/guides/query-invalidation)

### ì„±ëŠ¥ ê¸°ì¤€
- **Good**: < 100ms (ì‚¬ìš©ì ì²´ê° ë¶ˆê°€)
- **Acceptable**: 100-300ms (ì•½ê°„ ëŠë¦¼)
- **Poor**: > 300ms (ìµœì í™” í•„ìš”)

### í˜„ì¬ ìƒíƒœ
- **í‰ê·  200ms** â†’ **Good** âœ…
