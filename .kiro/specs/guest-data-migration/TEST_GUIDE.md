# Guest Data Migration - Test Guide

게스트 데이터 마이그레이션 기능의 통합 테스트 가이드입니다.

## 환경 요구사항

### ⚠️ 중요: 웹 브라우저 제한

SQLite는 웹 브라우저에서 제한적으로 작동합니다. 실제 테스트는 다음 환경에서 진행해야 합니다:

- **iOS**: iOS 시뮬레이터 또는 실제 디바이스
- **Android**: Android 에뮬레이터 또는 실제 디바이스

### 서버 실행

```bash
cd server
npm start
```

서버가 `http://localhost:5001`에서 실행되어야 합니다.

## 테스트 준비

### 1. 앱 실행

**iOS 시뮬레이터:**
```bash
cd client
npm start
# 그 다음 'i' 키를 눌러 iOS 시뮬레이터 실행
```

**Android 에뮬레이터:**
```bash
cd client
npm start
# 그 다음 'a' 키를 눌러 Android 에뮬레이터 실행
```

### 2. 테스트 화면 접근

1. 앱 실행 후 게스트로 로그인
2. 프로필 탭 이동
3. 디버그 화면 접근 (하단의 "Debug" 버튼)
4. "🔬 Guest Migration Test" 버튼 클릭

## 테스트 시나리오

### Scenario 1: 기본 게스트 데이터 마이그레이션

**목적**: 게스트 데이터를 기존 회원 계정으로 성공적으로 마이그레이션

**단계:**

1. **게스트 데이터 생성**
   - "Scenario 1: 기본 데이터" 버튼 클릭
   - 5개 일정, 2개 카테고리, 3개 완료 생성 확인
   - 통계에서 데이터 개수 확인

2. **로그인 시도**
   - "로그인 화면으로" 버튼 클릭
   - 기존 회원 계정 입력 (예: `test@example.com` / `password123`)
   - 로그인 버튼 클릭

3. **ActionSheet 확인**
   - "5개의 일정과 2개의 카테고리를 가져오시겠습니까?" 메시지 확인
   - "가져오기", "버리기", "취소" 옵션 확인

4. **마이그레이션 실행**
   - "가져오기" 선택
   - "데이터를 가져오는 중..." 로딩 확인
   - "마이그레이션 완료" Toast 확인

5. **결과 검증**
   - 홈 화면으로 이동 확인
   - 일정 화면에서 마이그레이션된 일정 확인
   - 카테고리 화면에서 "마이그레이션된 카테고리" 확인

**예상 결과:**
- ✅ 모든 게스트 데이터가 서버로 이전됨
- ✅ 클라이언트 SQLite가 비어있음
- ✅ 정회원으로 로그인됨

---

### Scenario 2: 게스트 데이터 버리기

**목적**: 게스트 데이터를 버리고 정회원으로 로그인

**단계:**

1. **게스트 데이터 생성** (Scenario 1과 동일)

2. **로그인 시도** (Scenario 1과 동일)

3. **ActionSheet에서 "버리기" 선택**
   - "버리기" 버튼 클릭
   - "로그인 성공" Toast 확인

4. **결과 검증**
   - 홈 화면으로 이동 확인
   - 일정 화면이 비어있음 확인 (게스트 데이터 없음)

**예상 결과:**
- ✅ 게스트 데이터가 삭제됨
- ✅ 정회원으로 로그인됨
- ✅ 서버에 게스트 데이터 없음

---

### Scenario 3: 빈 게스트 데이터 - 정상 로그인

**목적**: 게스트 데이터가 없을 때 ActionSheet 없이 정상 로그인

**단계:**

1. **빈 게스트 데이터 생성**
   - "Scenario 3: 빈 데이터" 버튼 클릭
   - 모든 데이터 삭제 확인

2. **로그인 시도**
   - "로그인 화면으로" 버튼 클릭
   - 기존 회원 계정 입력
   - 로그인 버튼 클릭

3. **결과 검증**
   - ActionSheet가 표시되지 않음 확인
   - 바로 "로그인 성공" Toast 확인
   - 홈 화면으로 이동 확인

**예상 결과:**
- ✅ ActionSheet 표시 안됨
- ✅ 정상 로그인
- ✅ 홈 화면으로 이동

---

### Scenario 6: 대용량 데이터 마이그레이션

**목적**: 대용량 게스트 데이터(100개 일정)를 마이그레이션

**단계:**

1. **대용량 게스트 데이터 생성**
   - "Scenario 6: 대용량 데이터" 버튼 클릭
   - 확인 다이얼로그에서 "생성" 선택
   - 100개 일정, 10개 카테고리, 50개 완료 생성 확인 (시간 소요)

2. **마이그레이션 실행** (Scenario 1과 동일)

3. **성능 측정**
   - 마이그레이션 시작부터 완료까지 시간 측정
   - 목표: < 10초

**예상 결과:**
- ✅ 대용량 데이터 마이그레이션 성공
- ✅ 모든 데이터 무결성 유지
- ✅ 성능: < 10초

---

## 에러 시나리오 테스트

### Scenario 4: 네트워크 오류

**단계:**

1. 게스트 데이터 생성 (Scenario 1과 동일)
2. **서버 중단**: 터미널에서 서버 프로세스 종료 (Ctrl+C)
3. 로그인 시도 및 "가져오기" 선택
4. "네트워크 오류" Toast 확인
5. 게스트 세션 유지 확인 (여전히 게스트 데이터 존재)

**예상 결과:**
- ✅ 네트워크 오류 Toast
- ✅ 게스트 세션 유지
- ✅ SQLite 데이터 유지

---

### Scenario 5: 인증 실패

**단계:**

1. 게스트 데이터 생성 (Scenario 1과 동일)
2. **잘못된 비밀번호로 로그인 시도**
3. ActionSheet에서 "가져오기" 선택
4. "비밀번호가 일치하지 않습니다" Toast 확인
5. 게스트 세션 유지 확인

**예상 결과:**
- ✅ 인증 실패 Toast
- ✅ 게스트 세션 유지
- ✅ SQLite 데이터 유지

---

## 데이터 검증

### 클라이언트 SQLite 검증

디버그 화면에서:
- "🔍 DB 상태 확인" 버튼으로 SQLite 통계 확인
- 마이그레이션 후 모든 데이터가 0개여야 함

### 서버 MongoDB 검증

MongoDB Compass 또는 mongo shell에서:

```javascript
// 사용자 조회
db.users.findOne({ email: 'test@example.com' })

// 마이그레이션된 일정 조회
db.todos.find({ userId: '<user_id>' })

// 마이그레이션된 카테고리 조회
db.categories.find({ userId: '<user_id>', name: '마이그레이션된 카테고리' })

// 완료 정보 조회
db.completions.find({ userId: '<user_id>' })
```

---

## 정리

### 테스트 후 정리

1. **클라이언트 데이터 삭제**
   - 디버그 화면 → "🗑️ SQLite 전체 초기화"

2. **서버 데이터 삭제**
   ```javascript
   // MongoDB shell
   db.todos.deleteMany({ userId: '<test_user_id>' })
   db.categories.deleteMany({ userId: '<test_user_id>' })
   db.completions.deleteMany({ userId: '<test_user_id>' })
   ```

3. **로그아웃**
   - 프로필 → 로그아웃

---

## 문제 해결

### SQLite 초기화 실패

**증상**: "Database not initialized" 에러

**해결**:
1. 앱 완전 종료 후 재시작
2. 디바이스/시뮬레이터 재부팅
3. 앱 데이터 삭제 후 재설치

### 서버 연결 실패

**증상**: "네트워크 오류" Toast

**해결**:
1. 서버가 실행 중인지 확인 (`http://localhost:5001`)
2. `.env` 파일의 `EXPO_PUBLIC_API_URL` 확인
3. 네트워크 연결 확인

### ActionSheet 표시 안됨

**증상**: 게스트 데이터가 있는데 ActionSheet가 표시되지 않음

**해결**:
1. 디버그 화면에서 "게스트 데이터 확인" 버튼으로 실제 데이터 확인
2. `authStore.checkGuestData()` 로그 확인
3. SQLite 데이터 확인

---

## 체크리스트

### 기본 플로우
- [x] 게스트 데이터 생성
- [ ] 로그인 시 ActionSheet 표시
- [ ] "가져오기" 선택 → 마이그레이션 성공
- [ ] "버리기" 선택 → 데이터 삭제 후 로그인
- [ ] "취소" 선택 → 로그인 취소

### 에러 케이스
- [ ] 네트워크 오류 → 게스트 세션 유지
- [ ] 비밀번호 불일치 → 인증 실패 Toast
- [ ] 서버 오류 → 에러 Toast

### UI/UX
- [ ] 로딩 인디케이터 표시
- [ ] Toast 메시지 정확성
- [ ] ActionSheet 디자인 (iOS/Android)
- [ ] 버튼 비활성화 (로딩 중)

### 데이터 무결성
- [ ] SQLite 데이터 삭제 확인
- [ ] 서버 데이터 삽입 확인
- [ ] userId 일치 확인
- [ ] categoryId 일치 확인

---

## 참고 문서

- [Requirements](./requirements.md)
- [Design](./design.md)
- [Tasks](./tasks.md)
- [Integration Test Scenarios](./integration-test-scenarios.md)
